<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Metabolite Novelty Survey</title>
  <!-- SurveyJS styles & scripts -->
  <link href="https://unpkg.com/survey-core/defaultV2.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/jquery/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/survey-core/survey.min.js"></script>
  <script src="https://unpkg.com/survey-jquery/survey.jquery.min.js"></script>
  <style>
    body { max-width: 800px; margin: 2em auto; font-family: sans-serif; }
    .vignette-title { font-weight: bold; margin-top: 1.5em; }
    .vignette-image { max-width: 100%; margin: 0.5em 0; }
  </style>
</head>
<body>
  <h1>Metabolite Novelty Survey</h1>
  <div id="surveyContainer"></div>

  <script>
    Survey.StylesManager.applyTheme("defaultV2");

    //
    // ─── BLOCK 0: INTRO & CONSENT ────────────────────────────────────────────────
    //
    const introPage = {
      name: "intro",
      elements: [
        {
          type: "html",
          html: `
            <p><strong>Purpose:</strong> We’re investigating how researchers define “novel” metabolites.</p>
            <p><strong>Anonymity:</strong> Your answers are recorded anonymously.</p>
            <p><strong>Time:</strong> ~8 minutes.</p>
            <p><strong>Voluntary:</strong> You may stop at any time.</p>
            <p><em>By clicking “Next,” you consent to participate.</em></p>
          `
        }
      ]
    };

    //
    // ─── BLOCK 1: OPEN QUESTION ─────────────────────────────────────────────────
    //
    const openQuestionPage = {
      name: "open1",
      elements: [
        {
          type: "comment",
          name: "novelty_definition",
          title: "In your own words, what makes a metabolite “novel”?"
        }
      ]
    };

    //
    // ─── BLOCK 2: SCALING ASSESSMENT ─────────────────────────────────────────────
    //
    function getRandomItems(arr, n) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    const structuralPool = [
      { value: "S1", text: "Incorporation of rare elements such as selenium or boron increases a metabolite’s novelty." },
      { value: "S2", text: "A new ring system is an indicator of novelty." },
      { value: "S3_R", text: "N-acylation or similar motif-based decoration are unimportant when claiming novelty. (R)" },
      { value: "S4_R", text: "Changing the oxidation state of a functional group is of little novelty. (R)" }
    ];
    const biosyntheticPool = [
      { value: "B1", text: "An enzyme that catalyses an unprecedented reaction is novel." },
      { value: "B2", text: "Use of uncommon cofactors increases the novelty of a pathway." },
      { value: "B3_R", text: "Including a tailoring enzyme from another pathway is of low novelty. (R)" },
      { value: "B4_R", text: "If the final product resembles a known compound, the catalysis is not novel. (R)" }
    ];
    const functionalPool = [
      { value: "F1", text: "Bioactivity in an under-explored target class is an important factor for novelty." },
      { value: "F2_R", text: "Without demonstrated bioactivity, a new structure is not an important novelty discovery. (R)" },
      { value: "F3", text: "Selective activity against a previously untreatable pathogen is an important novelty signal." },
      { value: "F4", text: "Dual-function metabolites (e.g. toxin + signal) are an important form of novelty." }
    ];
    const ecologicalPool = [
      { value: "E1", text: "Production by a taxon where the compound was never seen is an important novelty factor." },
      { value: "E2", text: "Chemical convergence across distant lineages is an important novelty cue." },
      { value: "E3_R", text: "Finding a known metabolite in a new species is not an important novelty event. (R)" },
      { value: "E4", text: "Chemical-diversity hotspots in unexplored biomes are important indicators of future novelty." }
    ];

    const selectedStructural   = getRandomItems(structuralPool, 2);
    const selectedBiosynthetic = getRandomItems(biosyntheticPool, 2);
    const selectedFunctional   = getRandomItems(functionalPool, 2);
    const selectedEcological   = getRandomItems(ecologicalPool, 2);

    const likertCols = [
      { value: 1,   text: "1<br>Strongly disagree" },
      { value: 2,   text: "2<br>Disagree" },
      { value: 3,   text: "3<br>Slightly disagree" },
      { value: 4,   text: "4<br>Neutral" },
      { value: 5,   text: "5<br>Slightly agree" },
      { value: 6,   text: "6<br>Agree" },
      { value: 7,   text: "7<br>Strongly agree" },
      { value: "NA", text: "Not applicable / no opinion" }
    ];

    const scalePage = {
      name: "scale2",
      elements: [
        {
          type: "html",
          html: "<h3>Block 2: Scaling assessment</h3><p>Purpose: Capture respondents’ latent rules-of-thumb about novelty—independent of any single molecule.</p>"
        },
        {
          type: "matrix",
          name: "structural_novelty",
          title: "Structural Novelty",
          columns: likertCols,
          rows: selectedStructural
        },
        {
          type: "matrix",
          name: "biosynthetic_novelty",
          title: "Biosynthetic / Catalytic Novelty",
          columns: likertCols,
          rows: selectedBiosynthetic
        },
        {
          type: "matrix",
          name: "functional_novelty",
          title: "Functional / Phenotypic Novelty",
          columns: likertCols,
          rows: selectedFunctional
        },
        {
          type: "matrix",
          name: "ecological_novelty",
          title: "Ecological / Phylogenetic Novelty",
          columns: likertCols,
          rows: selectedEcological
        }
      ]
    };

    //
    // ─── BLOCK 3: FORCED-CHOICE / RANKING ────────────────────────────────────────
    //
    const masterPage = {
      name: "block3_master",
      elements: [
        {
          type: "html",
          html: `
            <h3>Block 3: Category Ranking</h3>
            <p>“Drag the four cards so that #1 marks the domain you consider <strong>most important</strong> when deciding whether a metabolite is truly novel, and #4 the <strong>least important</strong>.”<br/>
            Please break ties by gut feeling; there is no “right” answer.</p>
          `
        },
        {
          type: "ranking",
          name: "master_ranking",
          title: "Rank the domains",
          choices: [
            { value: "structure",    text: "Structural / Scaffold novelty" },
            { value: "biosynthetic", text: "Biosynthetic / Catalytic novelty" },
            { value: "functional",   text: "Functional / Phenotypic novelty" },
            { value: "evolutionary", text: "Evolutionary / Ecological novelty" }
          ]
        }
      ]
    };

    const subPage = {
      name: "block3_sub",
      elements: [
        {
          type: "html",
          name: "sub_intro",
          html: `
            <p>Now, among your top two domains from the previous page, one category was randomly selected. Please rank its subcategories from #1 (most important) to #<span id="sub-count">X</span> (least important).</p>
          `
        },
        {
          type: "ranking",
          name: "sub_structure",
          title: "Structural / Scaffold novelty – Rank these subcategories",
          choices: [
            { value: "new_scaffold",    text: "New carbon/heteroatom scaffold" },
            { value: "unusual_fg",      text: "Unusual functional group (e.g., N = N = N)" },
            { value: "rare_stereo",     text: "Rare stereochemical pattern" },
            { value: "exotic_atoms",    text: "Presence of “exotic” atoms (e.g., F or Br)" },
            { value: "extreme_size",    text: "Extreme size/complexity related to carbons (ratio C/Hetero is high or low)" }
          ],
          visible: false
        },
        {
          type: "ranking",
          name: "sub_biosynthetic",
          title: "Biosynthetic / Catalytic novelty – Rank these subcategories",
          choices: [
            { value: "new_enzyme",          text: "Entirely new enzyme class (e.g. new fold + AA homology low)" },
            { value: "known_new_chem",      text: "Known folds, new catalytic chemistry" },
            { value: "uncommon_cofactors",  text: "Use of uncommon cofactors" },
            { value: "convergent_pathways", text: "Compounds produced by convergence of 2 pathways" }
          ],
          visible: false
        },
        {
          type: "ranking",
          name: "sub_functional",
          title: "Functional / Phenotypic novelty – Rank these subcategories",
          choices: [
            { value: "new_bioactivity",   text: "New bioactivity spectrum" },
            { value: "new_mode_action",   text: "New mode of action for a known target" },
            { value: "new_eco_role",      text: "New Ecological role for a taxonomic rank" }
          ],
          visible: false
        },
        {
          type: "ranking",
          name: "sub_evolutionary",
          title: "Evolutionary / Ecological novelty – Rank these subcategories",
          choices: [
            { value: "new_taxon",         text: "Produced by a previously unsuspected taxon" },
            { value: "signature_compound",text: "Unique to a taxon (signature compound)" },
            { value: "horizontal_transfer",text: "Horizontal transfer" }
          ],
          visible: false
        }
      ]
    };

    //
    // ─── BLOCK 4: THRESHOLD VIGNETTES ────────────────────────────────────────────
    //
    // Define each domain’s full vignette pool here. Add "title" and optional "imageUrl" for each vignette.
    // – “id” must be unique. The code below uses id to build question‐names like "v_S1_novel", "v_S1_confidence", etc.
    //
    const structuralVignettes = [
      {
        id: "S1",
        title: `S-1. <code>CCCC[C@H]1CCCC[C@H](C)CC2=CC(O)=C(C(O)=C2)[C@@H](CCCC)CCCC[C@H](C)CC3=CC(O)=C1C(O)=C3</code>`,
        imageUrl: "" // e.g. "images/S1.png"
      },
      {
        id: "S2",
        title: `S-2. <code>O=C(NCC(O)=O)[C@@H]1CSC(C2=CC=C(O)C(Cl)=C2O)=N1</code>`,
        imageUrl: ""
      },
      {
        id: "S3",
        title: `S-3. Bipolarsterol A`,
        imageUrl: ""
      },
      {
        id: "S4",
        title: `S-4. Fluoro AA (from Andrej)`,
        imageUrl: ""
      },
      {
        id: "S5",
        title: `S-5. [Insert your structure or description here]`,
        imageUrl: ""
      },
      {
        id: "S6",
        title: `S-6. Iullia novelty score: <code>C1CN(C(=N1)N[N+](=O)[O-])CC2=CN=C(C=C2)Cl</code>`,
        imageUrl: ""
      },
      {
        id: "S7",
        title: `S-7. Iullia novelty score: <code>CC(C1CCC2(C)C13C(O)C=C(C(OC)=O)C(OO3)C2)C</code>`,
        imageUrl: ""
      },
      {
        id: "S8",
        title: `S-8. Iullia novelty score: <code>CC1=CC2=C(N(C[C@H](O)[C@H](O)[C@H](O)COP(O)(OP(O)(OC[C@@H]3[C@@H](O)[C@@H](O)[C@H](N4C=NC5=C(N)N=CN=C54)O3)=O)=O)C6=NC(NC(C6=N2)=O)=O)C=C1C</code>`,
        imageUrl: ""
      }
    ];

    const biosyntheticVignettes = [
      {
        id: "B1",
        title: `B-1. <a href="https://www.nature.com/articles/s41589-022-01013-7" target="_blank">Nature Chem. Biol. s41589-022-01013-7</a>`,
        imageUrl: ""
      },
      {
        id: "B2",
        title: `B-2. <a href="https://www.nature.com/articles/s41557-024-01646-2" target="_blank">Nature s41557-024-01646-2</a>`,
        imageUrl: ""
      },
      {
        id: "B3",
        title: `B-3. <a href="https://www.nature.com/articles/s41557-024-01603-z" target="_blank">Nature s41557-024-01603-z</a>`,
        imageUrl: ""
      },
      {
        id: "B4",
        title: `B-4. <a href="https://www.nature.com/articles/s41467-024-49650-x" target="_blank">Nat. Comm. s41467-024-49650-x</a>`,
        imageUrl: ""
      },
      {
        id: "B5",
        title: `B-5. DOI: 10.1002/anie.202414941`,
        imageUrl: ""
      },
      {
        id: "B6",
        title: `B-6. DOI: s41589-025-01898-0`,
        imageUrl: ""
      },
      {
        id: "B7",
        title: `B-7. DOI: s41589-023-01445-9`,
        imageUrl: ""
      },
      {
        id: "B8",
        title: `B-8. DOI: 10.1002/anie.202304646`,
        imageUrl: ""
      }
    ];

    const functionalVignettes = [
      {
        id: "F1",
        title: `F-1. Clovibactin (S0092-8674(23)00853-X): “Clovibactin, a depsipeptide from an uncultured soil bacterium, kills all tested Gram-positive superbugs with no detectable resistance after 30 passages.”`,
        imageUrl: ""
      },
      {
        id: "F2",
        title: `F-2. Evybactin (s41589-022-01102-7): “Evybactin selectively wipes out Mycobacterium tuberculosis by stalling DNA gyrase; it is inactive vs. commensal flora.”`,
        imageUrl: ""
      },
      {
        id: "F3",
        title: `F-3. Erucamide (10.1126/science.ads0377): “Erucamide, a ubiquitous plant fatty-amide, blocks bacterial T3SS needles.”`,
        imageUrl: ""
      },
      {
        id: "F4",
        title: `F-4. Photoxenobactin C (s41557-022-00923-2): “Photoxenobactin C, with a dithioperoxoate terminus, is a non-siderophore insecticide.”`,
        imageUrl: ""
      }
    ];

    const evolutionaryVignettes = [
      {
        id: "E1",
        title: `E-1. (s40168-023-01521-1) “First lanthipeptides in archaea.”`,
        imageUrl: ""
      },
      {
        id: "E2",
        title: `E-2. DOI 10.1073/pnas.2311245121: “Psilocybin biosynthesis first arose in Psilocybe, with 4–5 possible horizontal transfers between 40 and 9 mya.”`,
        imageUrl: ""
      },
      {
        id: "E3",
        title: `E-3. DOI 10.1073/pnas.2307981120: “Discovery of two benzoxazinoid pathways showing independent evolution in flowering plants at least three times.”`,
        imageUrl: ""
      },
      {
        id: "E4",
        title: `E-4. DOI 10.1073/pnas.2303327120: “Entomopathogenic Beauveria fungi obtained a bacterial Fcs1 Pictet-Spenglerase, enabling β-carboline alkaloid biosynthesis.”`,
        imageUrl: ""
      }
    ];

    // Combine domain‐level arrays into an object for easy lookup:
    const domainVignettes = {
      structure:    structuralVignettes,
      biosynthetic: biosyntheticVignettes,
      functional:   functionalVignettes,
      evolutionary: evolutionaryVignettes
    };

    // BLOCK 4 page is blank for now; we will fill it dynamically when the user arrives.
    const block4Page = {
      name: "block4",
      elements: [] // → will be populated in onCurrentPageChanged
    };

    //
    // ─── ASSEMBLE ALL PAGES ─────────────────────────────────────────────────────
    //
    const surveyJSON = {
      title: "Metabolite Novelty Survey",
      showQuestionNumbers: "off",
      pages: [
        introPage,           // Block 0
        openQuestionPage,    // Block 1
        scalePage,           // Block 2
        masterPage,          // Block 3.1
        subPage,             // Block 3.2
        block4Page           // Block 4 (filled dynamically)
      ],
      pagePrevText: "Back",
      pageNextText: "Next",
      completeText: "Submit"
    };

    //
    // ─── INITIALIZE SURVEY ───────────────────────────────────────────────────────
    //
    const survey = new Survey.Model(surveyJSON);

    //
    // ─── DYNAMIC SHOW/HIDE FOR BLOCK 3.2 ───────────────────────────────────────
    //
    survey.onValueChanged.add(function (sender, options) {
      if (options.name === "master_ranking") {
        const ranks = sender.getValue("master_ranking");
        if (Array.isArray(ranks) && ranks.length >= 2) {
          const topTwo = [ranks[0], ranks[1]];
          const chosenDomain = topTwo[Math.floor(Math.random() * 2)]; // one of the top two

          // hide all sub_* first:
          ["sub_structure","sub_biosynthetic","sub_functional","sub_evolutionary"].forEach(qn => {
            const qObj = sender.getQuestionByName(qn);
            if (qObj) qObj.visible = false;
          });

          // unhide the chosen domain’s subquestion:
          const subName = "sub_" + chosenDomain;
          const chosenQ = sender.getQuestionByName(subName);
          if (chosenQ) chosenQ.visible = true;

          // update the “#X” placeholder to the correct number of subcategories:
          const countMap = {
            "sub_structure":    structuralPool.length === 4 ? 5 : structuralPool.length, 
            "sub_biosynthetic": biosyntheticPool.length,
            "sub_functional":   functionalPool.length,
            "sub_evolutionary": ecologicalPool.length
          };
          const totalItems = countMap[subName] || 0;
          const subIntro = sender.getQuestionByName("sub_intro");
          if (subIntro) {
            subIntro.html = `
              <p>Now, among your top two domains from the previous page, one category was randomly selected. 
              Please rank its subcategories from #1 (most important) to #${totalItems} (least important).</p>
            `;
          }
        }
      }
    });

    //
    // ─── DYNAMIC POPULATION OF BLOCK 4 (VIGNETTES) ──────────────────────────────
    //
    let block4Filled = false; 
    survey.onCurrentPageChanged.add(function (sender, options) {
      const page = sender.currentPage;
      if (page.name === "block4" && !block4Filled) {
        block4Filled = true; // only populate once

        const data = sender.data;
        const masterRanks = data.master_ranking || []; 
        // masterRanks is an array of ['structure','biosynthetic','functional','evolutionary'] in some order.

        // 1) Identify top domain and second domain from master ranking:
        const topDomain    = masterRanks[0];
        const secondDomain = masterRanks[1];
        const lowDomains   = [masterRanks[2], masterRanks[3]]; // domains ranked 3 & 4

        // 2) From topDomain, pick 4 random vignettes
        const topPool = domainVignettes[topDomain] || [];
        const fourFromTop = getRandomItems(topPool, 4);

        // 3) From secondDomain, pick 1 random vignette
        const secondPool = domainVignettes[secondDomain] || [];
        const oneFromSecond = getRandomItems(secondPool, 1);

        // 4) From a randomly selected “low” domain, pick 1 vignette
        const randomLowDomain = lowDomains[Math.floor(Math.random() * lowDomains.length)];
        const lowPool = domainVignettes[randomLowDomain] || [];
        const oneFromLow = getRandomItems(lowPool, 1);

        // 5) Combine into an array of exactly 6 vignettes (objects with {id, title, imageUrl})
        const selectedVignettes = [
          ...fourFromTop,
          ...oneFromSecond,
          ...oneFromLow
        ];

        // 6) For each selected vignette, add three questions to block4Page:
        selectedVignettes.forEach((v, idx) => {
          // a) Display title and optional image:
          const htmlContent = [
            `<div class="vignette-title">${v.title}</div>`
          ];
          if (v.imageUrl && v.imageUrl.length > 0) {
            htmlContent.push(`<img class="vignette-image" src="${v.imageUrl}" alt="${v.id}">`);
          }

          // Add an HTML panel so the title (and image) appear
          page.addNewPageElement({
            type: "html",
            html: htmlContent.join("\n")
          });

          // b) “Would you consider this novel?” → binary choice
          page.addNewPageElement({
            type: "radiogroup",
            name: `v_${v.id}_novel`,
            title: "Would you consider this novel?",
            isRequired: true,
            choices: [
              { value: "Yes", text: "Yes" },
              { value: "No",  text: "No" }
            ]
          });

          // c) Confidence slider (0–10) using Rating (0 to 10)
          page.addNewPageElement({
            type: "rating",
            name: `v_${v.id}_confidence`,
            title: "Confidence (0–10)",
            isRequired: true,
            rateMin: 0,
            rateMax: 10,
            minRateDescription: "0",
            maxRateDescription: "10"
          });

          // d) “Wow” (excitement) slider (0–10) using Rating (0 to 10)
          page.addNewPageElement({
            type: "rating",
            name: `v_${v.id}_wow`,
            title: "Scientific excitement / “Wow” effect (0–10)",
            isRequired: true,
            rateMin: 0,
            rateMax: 10,
            minRateDescription: "0",
            maxRateDescription: "10"
          });
        });

        // Finally, re-render the page so the new elements appear
        sender.render(true);
      }
    });

    //
    // ─── ON COMPLETE: POST DATA TO YOUR APPS SCRIPT ───────────────────────────────
    //
    survey.onComplete.add(function (sender) {
      const endpoint = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // ← REPLACE WITH YOUR DEPLOYED URL
      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sender.data)
      })
      .then(() => {
        document.querySelector("#surveyContainer")
          .innerHTML = "<h2>Thank you! Your responses have been recorded.</h2>";
      })
      .catch(err => console.error(err));
    });

    //
    // ─── RENDER THE SURVEY ───────────────────────────────────────────────────────
    //
    $("#surveyContainer").Survey({ model: survey });
  </script>
</body>
</html>
