<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metabolite Novelty Survey</title>

  <!-- RESPONSIVE -->
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- SURVEYJS THEME (pinned) -->
  <link rel="stylesheet"
        href="https://unpkg.com/survey-core@2.1.0/defaultV2.min.css">

  <!-- CUSTOM BRAND TWEAKS -->
  <style>
    :root {
      --sjs-primary-backcolor: #0060df;       /* buttons etc. */
      --sjs-primary-backcolor-dark: #0047a6;  /* pressed/hover state */
    }
    body {
      max-width: min(90vw, 48rem);
      margin: 2rem auto;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      line-height: 1.55;
    }
    .sv_matrix,
    .sv_matrix_dynamic {
      overflow-x: auto; /* mobile-friendly Likert table */
    }
    footer {
      margin-top: 3rem;
      font-size: .875rem;
      color: #555;
    }
  </style>

  <!-- LIBRARIES (all deferred) -->
  <script src="https://unpkg.com/knockout@3.5.1/build/output/knockout-latest.js" defer></script>
  <script src="https://unpkg.com/seedrandom@3.0.5/seedrandom.min.js" defer></script>
  <script src="https://unpkg.com/survey-core@2.1.0/survey.core.min.js" defer></script>
  <script src="https://unpkg.com/survey-knockout-ui@2.1.0/survey-knockout-ui.min.js" defer></script>
</head>

<body>
  <h1 id="title">Metabolite Novelty Survey</h1>
  <div id="surveyContainer"></div>

  <footer>
    Questions about this study? Contact <strong>Dr Ada Lovelace</strong>
    (<a href="mailto:ada@example.edu">ada@example.edu</a>). Approved by
    University IRB #2025-042.
  </footer>

  <script>
    // ----------  RANDOMISATION HELPER  ----------
    // Generate a unique seed per respondent for reproducible randomisation
    const clientSeed = Survey.Helpers.randomizeId();
    const rng = new Math.seedrandom(clientSeed);

    function sample(array, n) {
      // Shuffle using SurveyJS helper + seedrandom, then take first n
      return Survey.Helpers.shuffle(array, rng).slice(0, n);
    }

    // ----------  SURVEY PAGES ----------
    // 1) Consent page
    const consentPage = {
      name: "consent",
      title: "Consent",
      elements: [
        {
          type: "radiogroup",
          name: "consent",
          title: "Do you consent to participate in this study?",
          isRequired: true,
          choices: [
            "Yes, I consent",
            "No, I do not consent"
          ],
          colCount: 1
        }
      ]
    };

    // 2) Open-ended definition page
    const openQuestionPage = {
      name: "defineme",
      title: "In your own words …",
      elements: [
        {
          type: "comment",
          name: "definition",
          title: "How would you define a <em>novel metabolite</em>?",
          isRequired: true
        }
      ],
      visibleIf: "{consent} = 'Yes, I consent'"
    };

    // 3) Likert scale page with “Not applicable” as a separate row
    const likertChoices = ["1", "2", "3", "4", "5", "6", "7"];
    const likertCols = likertChoices.map(c => ({ value: c, text: c }));

    const statements = [
      "Is absent from any public spectral library",
      "Has never been mentioned in peer-reviewed literature (R)",
      "Is <em>structurally</em> unrelated to known metabolites (R)",
      "Appears only in extreme environmental niches"
    ];
    // Randomise order of statements
    const matrixRows = sample(
      statements.map((text, i) => ({ value: `stmt${i + 1}`, text })),
      statements.length
    );

    // Add “Not applicable” as its own row at the end
    matrixRows.push({ value: "na", text: "Not applicable" });

    const scalePage = {
      name: "criteria",
      title: "How strongly do you agree with each statement?",
      elements: [
        {
          type: "matrix",
          name: "likert",
          isAllRowRequired: true,
          columns: likertCols,
          rows: matrixRows
        }
      ],
      visibleIf: "{consent} = 'Yes, I consent'"
    };

    // ----------  ASSEMBLE SURVEY ----------
    const surveyJSON = {
      title: "Metabolite Novelty Survey",
      showProgressBar: "bottom",
      progressBarType: "pages",
      showQuestionNumbers: "off",
      completedHtml: "<h2>Thank you! Your responses were recorded.</h2>",
      pages: [
        consentPage,
        openQuestionPage,
        scalePage
      ],
      pagePrevText: "Back",
      pageNextText: "Next",
      completeText: "Submit"
    };

    const survey = new Survey.Model(surveyJSON);

    // ----------  CONSENT LOGIC ----------
    survey.onCurrentPageChanging.add(function (sender, options) {
      // Check if we're leaving the consent page
      if (
        options.oldCurrentPage &&
        options.oldCurrentPage.name === "consent"
      ) {
        const answer = sender.getValue("consent");
        // If the respondent clicked “No, I do not consent”, cancel navigation and finish survey
        if (answer === "No, I do not consent") {
          options.allowChanging = false; // prevent page change
          sender.completeLastPage();     // trigger completion
        }
      }
    });

    // ----------  SUBMIT HANDLER ----------
    survey.onComplete.add(function (sender) {
      // Attach the randomisation seed for reproducibility
      sender.data.__seed = clientSeed;

      fetch("/api/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sender.data)
      })
      .then(function () {
        // Replace survey container with a thank-you message
        document.getElementById("surveyContainer").innerHTML =
          "<h2>Thank you! Your responses were recorded.</h2>";
      })
      .catch(function (error) {
        console.error("Submission error:", error);
      });
    });

    // ----------  RENDER SURVEY ----------
    document.addEventListener("DOMContentLoaded", function () {
      survey.render("surveyContainer");
    });
  </script>
</body>
</html>
