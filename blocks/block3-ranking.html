<!-- File: blocks/block3-ranking.html -->

<section class="survey-block" id="block3" data-type="ranking">
  <h2>Block 3 – Domain Prioritization</h2>
  <p class="prompt">
    Please assign a unique rank to each domain (1 = most important, 4 = least important).  
    Type a number (1–4) in the box next to each statement. Do not repeat ranks.
  </p>

  <!-- Container where we will dynamically inject the four “domain” ranking items -->
  <div id="vignette-list"></div>

  <!-- Navigation Buttons for Block 3 -->
  <div class="navigation">
    <button class="prev-btn">Back</button>
    <button class="next-btn">Next</button>
  </div>

  <!-- ─────────────────────────────────────────────────────────────────
       Duplicate‐value checker (unchanged from your original)
     ───────────────────────────────────────────────────────────────── -->
  <script>
    function checkDups() {
      const inputs = document.querySelectorAll('#block3 .rank-input');
      const counts = {};

      inputs.forEach(input => {
        const val = input.value.trim();
        // only consider numbers 1–4
        if (!val || !/^[1-4]$/.test(val)) return;
        counts[val] = (counts[val] || 0) + 1;
      });

      inputs.forEach(input => {
        const val = input.value.trim();
        if (val && counts[val] > 1) {
          input.classList.add('duplicate');
        } else {
          input.classList.remove('duplicate');
        }
      });
    }
  </script>

  <!-- ─────────────────────────────────────────────────────────────────
       SCRIPT: Build & persist the four domain‐ranking items dynamically
     ───────────────────────────────────────────────────────────────── -->
  <script>
    (function() {
      // 1) The four top‐level domains and their display labels
      const domains = [
        { id: 'Structural',  label: 'Structural / Scaffold novelty' },
        { id: 'Biosynthetic', label: 'Biosynthetic / Catalytic novelty' },
        { id: 'Functional',   label: 'Functional / Phenotypic novelty' },
        { id: 'Evolutionary', label: 'Evolutionary / Ecological novelty' }
      ];

      // 2) Fisher–Yates shuffle (in‐place)
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      // 3) Ensure we have a single “order” for these four domains in memory
      //    If not defined yet, shuffle once and store in window.block3Order.
      let order = window.block3Order;
      if (!order) {
        order = domains.map(d => d.id);
        shuffle(order);
        window.block3Order = order;
      }

      // 4) Retrieve (or initialize) any saved answers in window.block3Answers
      //    This lives only in memory and is cleared on a full reload.
      if (!window.block3Answers) {
        window.block3Answers = {};
        // e.g. { Structural: "2", Biosynthetic: "1", … } as the user fills in
      }

      // 5) Grab the container where we’ll render the four ranking‐items
      const container = document.getElementById('vignette-list');
      container.innerHTML = ''; // clear any previous render

      // 6) For each domain ID in `order`, build a .ranking-item block
      order.forEach(domainId => {
        // (a) Find the label from our `domains` array
        const domainObj = domains.find(d => d.id === domainId);

        // (b) Create the outer wrapper <div class="ranking-item">
        const itemDiv = document.createElement('div');
        itemDiv.className = 'ranking-item';

        // (c) Inside it, create <div class="number-wrapper">…</div>
        const numberWrapper = document.createElement('div');
        numberWrapper.className = 'number-wrapper';

        // Create the <input type="number" class="rank-input">
        const input = document.createElement('input');
        input.type = 'number';
        input.name = `rank_${domainObj.id}`;
        input.id = `rank_${domainObj.id}`;
        input.className = 'rank-input';
        input.min = '1';
        input.max = '4';
        input.required = true;
        input.setAttribute('oninput', 'checkDups()'); // call duplicate checker on every change

        // If the user already typed something, restore it now:
        const savedVal = window.block3Answers[domainObj.id];
        if (savedVal) {
          input.value = savedVal;
        }

        // Save any new changes into window.block3Answers immediately:
        input.addEventListener('input', () => {
          const v = input.value.trim();
          if (/^[1-4]$/.test(v)) {
            window.block3Answers[domainObj.id] = v;
          } else {
            delete window.block3Answers[domainObj.id];
          }
          checkDups();
        });

        // Create the up/down arrows
        const upArrow = document.createElement('div');
        upArrow.className = 'arrow up';
        const downArrow = document.createElement('div');
        downArrow.className = 'arrow down';

        // Bind arrow click handlers (exactly as your original code did)
        upArrow.addEventListener('click', () => {
          let value = parseInt(input.value || '0', 10);
          if (value < 4) {
            input.value = value + 1;
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
        downArrow.addEventListener('click', () => {
          let value = parseInt(input.value || '0', 10);
          if (value > 1) {
            input.value = value - 1;
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });

        // Nest input + arrows inside numberWrapper
        numberWrapper.appendChild(input);
        numberWrapper.appendChild(upArrow);
        numberWrapper.appendChild(downArrow);

        // (d) Create the <label> for this domain
        const label = document.createElement('label');
        label.setAttribute('for', `rank_${domainObj.id}`);
        label.innerHTML = `<strong>${domainObj.label}</strong>`;

        // (e) Assemble the ranking‐item: [numberWrapper] + [label]
        itemDiv.appendChild(numberWrapper);
        itemDiv.appendChild(label);

        // (f) Append this ranking‐item to the container
        container.appendChild(itemDiv);
      });

      // 7) After rendering, run checkDups() once (to highlight any duplicates)
      checkDups();
    })();
  </script>
</section>
