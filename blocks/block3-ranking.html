<!-- blocks/block3-ranking.html -->
<section class="survey-block" id="block3" data-type="ranking">
  <h2>Block 3 – Vignette Ranking</h2>
  <p class="prompt">
    Select a rank for each vignette from the dropdown on the right.
  </p>

  <div class="ranking-container">
    <!-- ====== VIGNETTE #1 ====== -->
    <div class="ranking-item" data-value="v1">
      <div class="vignette-text">
        <strong>Vignette 1:</strong> Lorem ipsum dolor sit amet, consectetur adipiscing elit…
      </div>
      <select name="rank_v1" class="rank-select">
        <option value="" disabled selected>Rank …</option>
        <option value="1">1 (most novel)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (least novel)</option>
      </select>
    </div>

    <!-- ====== VIGNETTE #2 ====== -->
    <div class="ranking-item" data-value="v2">
      <div class="vignette-text">
        <strong>Vignette 2:</strong> Consectetur adipiscing elit, sed do eiusmod tempor incididunt…
      </div>
      <select name="rank_v2" class="rank-select">
        <option value="" disabled selected>Rank …</option>
        <option value="1">1 (most novel)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (least novel)</option>
      </select>
    </div>

    <!-- ====== VIGNETTE #3 ====== -->
    <div class="ranking-item" data-value="v3">
      <div class="vignette-text">
        <strong>Vignette 3:</strong> Sed do eiusmod tempor incididunt ut labore et dolore magna…
      </div>
      <select name="rank_v3" class="rank-select">
        <option value="" disabled selected>Rank …</option>
        <option value="1">1 (most novel)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (least novel)</option>
      </select>
    </div>

    <!-- ====== VIGNETTE #4 ====== -->
    <div class="ranking-item" data-value="v4">
      <div class="vignette-text">
        <strong>Vignette 4:</strong> Incididunt ut labore et dolore magna aliqua…
      </div>
      <select name="rank_v4" class="rank-select">
        <option value="" disabled selected>Rank …</option>
        <option value="1">1 (most novel)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (least novel)</option>
      </select>
    </div>

    <!-- ====== VIGNETTE #5 ====== -->
    <div class="ranking-item" data-value="v5">
      <div class="vignette-text">
        <strong>Vignette 5:</strong> Magna aliqua ut enim ad minim veniam…
      </div>
      <select name="rank_v5" class="rank-select">
        <option value="" disabled selected>Rank …</option>
        <option value="1">1 (most novel)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (least novel)</option>
      </select>
    </div>
  </div>

  <!-- Hidden input to collect final ranking (e.g. "v3,v1,v5,v2,v4") -->
  <input type="hidden" name="vignetteRanking" id="vignetteRanking">

  <div class="navigation">
    <button class="prev-btn">Back</button>
    <button class="next-btn" id="submitRanking" disabled>Next</button>
  </div>
</section>

<!-- ====== JavaScript: Disabling Already‐Chosen Ranks ====== -->
<script>
  (function() {
    // Grab all dropdowns and relevant elements
    const selects    = document.querySelectorAll('.rank-select');
    const nextBtn    = document.getElementById('submitRanking');
    const hiddenIn   = document.getElementById('vignetteRanking');
    const items      = document.querySelectorAll('.ranking-item');

    function updateAll() {
      // 1) Build a list of currently chosen rank‐values (exclude empty)
      const chosenRanks = Array.from(selects)
        .map(s => s.value)
        .filter(v => v !== '');

      // 2) For each <select>, loop its <option> elements → disable if chosen elsewhere
      selects.forEach(curSel => {
        const myValue = curSel.value;
        Array.from(curSel.options).forEach(opt => {
          const val = opt.value;
          if (val === '') return; 
          // If this value is chosen in ANY other select (not this one), disable it
          const isTakenElsewhere = chosenRanks.includes(val) && val !== myValue;
          opt.disabled = isTakenElsewhere;
        });
      });

      // 3) Check if all dropdowns are filled (non‐empty) AND unique
      const allFilled = chosenRanks.length === selects.length;
      const allUnique = new Set(chosenRanks).size === selects.length;

      if (allFilled && allUnique) {
        nextBtn.disabled = false;

        // 4) Build the hidden input in rank‐order: [rank=1→vignetteID, rank=2→…]
        const ordered = [];
        for (let r = 1; r <= selects.length; r++) {
          items.forEach(item => {
            const sel = item.querySelector('select');
            if (parseInt(sel.value, 10) === r) {
              ordered.push(item.getAttribute('data-value'));
            }
          });
        }
        hiddenIn.value = ordered.join(',');
      } else {
        nextBtn.disabled = true;
        hiddenIn.value = '';
      }
    }

    // Attach 'change' listener to every dropdown
    selects.forEach(s => s.addEventListener('change', updateAll));

    // If you have any prefilled values (e.g. when navigating back), run once on load:
    document.addEventListener('DOMContentLoaded', updateAll);
  })();
</script>
