<!-- Block 3: Vignette Ranking -->
<section class="survey-block" id="block3" data-type="ranking">
  <h2>Block 3 – Vignette Ranking</h2>
  <p class="prompt">
    Use the dropdown on the left to assign each vignette a rank (1 → 2 → 3 …).  
    You can also drag any row (by clicking and holding anywhere on it) to reorder.
  </p>

  <!-- Scrollable wrapper -->
  <div class="ranking-wrapper">
    <ul id="rankingList" class="ranking-list">
      <!-- Copy/paste or edit these <li> blocks to match your vignette text. -->
      <!-- Each <li> must have data-value="..." and draggable="true". -->
      <li data-value="v1" draggable="true">
        <span class="order-select"><select></select></span>
        <span class="item-text">Vignette 1: Lorem ipsum dolor sit amet…</span>
        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
      </li>
      <li data-value="v2" draggable="true">
        <span class="order-select"><select></select></span>
        <span class="item-text">Vignette 2: Consectetur adipiscing elit…</span>
        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
      </li>
      <li data-value="v3" draggable="true">
        <span class="order-select"><select></select></span>
        <span class="item-text">Vignette 3: Sed do eiusmod tempor…</span>
        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
      </li>
      <li data-value="v4" draggable="true">
        <span class="order-select"><select></select></span>
        <span class="item-text">Vignette 4: Incididunt ut labore et dolore…</span>
        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
      </li>
      <li data-value="v5" draggable="true">
        <span class="order-select"><select></select></span>
        <span class="item-text">Vignette 5: Magna aliqua…</span>
        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
      </li>
    </ul>
  </div>

  <!-- Hidden input to capture final order as CSV (e.g. "v3,v1,v5,...") -->
  <input type="hidden" name="vignetteRanking" id="vignetteRanking" value="">

  <div class="navigation">
    <button class="prev-btn">Back</button>
    <button class="next-btn" id="submitRanking" disabled>Next</button>
  </div>
</section>

<script>
  (function() {
    const list = document.getElementById('rankingList');
    const hiddenInput = document.getElementById('vignetteRanking');
    const nextBtn = document.getElementById('submitRanking');

    // 1) INITIALIZE DROPDOWNS (1…N) ON PAGE LOAD
    function initSelects() {
      const items = Array.from(list.children);
      const N = items.length;
      items.forEach((li, idx) => {
        const select = li.querySelector('select');
        select.innerHTML = ''; 
        for (let i = 1; i <= N; i++) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = i;
          select.appendChild(opt);
        }
        select.value = idx + 1; // default: current index + 1
      });
      // Once dropdowns are filled, Next can be enabled
      nextBtn.disabled = false;
      updateHiddenInput();
    }

    // 2) WHEN A DROPDOWN CHANGES: MOVE THE <li> TO ITS NEW INDEX
    function handleSelectChange(e) {
      const select = e.target;
      const newRank = parseInt(select.value, 10);
      const li = select.closest('li');

      // Remove and re-insert <li> at position newRank - 1
      list.removeChild(li);
      const allLis = Array.from(list.children);
      if (newRank > allLis.length) {
        list.appendChild(li);
      } else {
        list.insertBefore(li, allLis[newRank - 1]);
      }
      reassignSelects();
      updateHiddenInput();
    }

    // 3) AFTER A DRAG-DROP, RENUMBERR ALL SELECTS IN VISUAL ORDER
    function reassignSelects() {
      Array.from(list.children).forEach((li, idx) => {
        li.querySelector('select').value = idx + 1;
      });
    }

    // 4) UPDATE HIDDEN CSV INPUT
    function updateHiddenInput() {
      const values = Array.from(list.children)
        .map(li => li.getAttribute('data-value'));
      hiddenInput.value = values.join(',');
    }

    // 5) DRAG & DROP SETUP (ANYWHERE ON <li>)
    let dragSrcEl = null;

    function handleDragStart(e) {
      dragSrcEl = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', ''); // Firefox needs this
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const targetLi = e.target.closest('li');
      if (!targetLi || targetLi === dragSrcEl) return;

      const rect = targetLi.getBoundingClientRect();
      const halfway = (rect.bottom - rect.top) / 2;
      const afterTarget = (e.clientY - rect.top) > halfway;
      if (afterTarget) {
        list.insertBefore(dragSrcEl, targetLi.nextSibling);
      } else {
        list.insertBefore(dragSrcEl, targetLi);
      }
    }

    function handleDragEnd() {
      this.classList.remove('dragging');
      reassignSelects();
      updateHiddenInput();
    }

    function attachDragListeners() {
      document.querySelectorAll('#rankingList li').forEach(li => {
        // Ensure draggable is true (redundant if already in HTML)
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', handleDragStart, false);
        li.addEventListener('dragover',  handleDragOver,  false);
        li.addEventListener('dragend',   handleDragEnd,   false);
      });
    }

    // 6) ATTACH SELECT CHANGE LISTENERS
    function attachSelectListeners() {
      document.querySelectorAll('#rankingList select').forEach(sel => {
        sel.addEventListener('change', handleSelectChange);
      });
    }

    // 7) TIE IT ALL TOGETHER ON LOAD
    function bootstrap() {
      initSelects();
      attachSelectListeners();
      attachDragListeners();
    }

    // Run after DOM is ready (script is at bottom of HTML, so it's safe)
    bootstrap();
  })();
</script>
